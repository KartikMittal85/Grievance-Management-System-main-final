<!-- templates/admin_feedbacks.html (updated) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Feedbacks — VoiceUp</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    body { font-family: Poppins, sans-serif; background: linear-gradient(160deg,#6a11cb,#2575fc); color:#0b1220; padding-bottom:120px; }
    .page-wrap { max-width:1100px; margin:36px auto; padding: 0 16px; }
    .feedback-card { background:#fff; padding:18px; border-radius:12px; margin-bottom:12px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); display:flex; gap:12px; }
    .avatar { width:56px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center; background: linear-gradient(180deg, rgba(106,17,203,0.12), rgba(37,117,252,0.06)); color:#fff; font-weight:700; }
    .badge-read { background:#e6f4ea; color:#0f7a4a; padding:6px 10px; border-radius:999px;}
    .badge-unread { background:#fff5e6; color:#c65a1a; padding:6px 10px; border-radius:999px;}
    .btn-xs { font-size:0.82rem; padding:6px 10px; border-radius:8px; }
    footer { position:fixed; left:0; right:0; bottom:-120px; height:78px; background:linear-gradient(120deg,#6a11cb,#2575fc); display:flex; align-items:center; justify-content:center; color:#fff; transition: bottom .36s ease; }
    footer.visible { bottom:0; }
  </style>
</head>
<body>
  <main class="page-wrap">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 style="color:#fff">Student Feedbacks</h2>
      <div>
        <input id="search" placeholder="Search name or email..." class="form-control" style="display:inline-block; width:300px;">
        <button id="refresh" class="btn btn-light btn-xs">Refresh</button>
      </div>
    </div>

    <div id="feedback-list">
      <!-- loaded by JS -->
      <div id="loading" class="text-white">Loading...</div>
    </div>

    <div id="empty" style="display:none; color:#fff; text-align:center; margin-top:30px;">
      <div style="font-size:48px; opacity:0.95;"><i class="bi bi-chat-left-quote"></i></div>
      <p class="mt-3">No feedbacks yet.</p>
    </div>
  </main>

  <footer id="pageFooter" aria-hidden="true">
    © 2025 VoiceUp Grievance Management System
  </footer>

<script>
  function renderList(items){
    const $list = $('#feedback-list').empty();
    if(!items || items.length === 0){
      $('#empty').show();
      return;
    }
    $('#empty').hide();
    items.forEach(function(f){
      const state = f.is_read ? 'Read' : 'Unread';
      const badge = f.is_read ? '<span class="badge-read">Read</span>' : '<span class="badge-unread">Unread</span>';
      const ipText = f.ip ? (' • IP: ' + f.ip) : '';
      const card = $(`
        <div class="feedback-card" data-name="${(f.name||'').toLowerCase()}" data-email="${(f.email||'').toLowerCase()}">
          <div class="avatar">${(f.name||'U').charAt(0).toUpperCase()}</div>
          <div style="flex:1">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <div>
                <div style="font-weight:700; color:#6a11cb;">${f.name}</div>
                <div style="color:#6b6b6b">${f.email}</div>
              </div>
              <div>${badge}</div>
            </div>
            <div style="margin-top:10px; color:#253046">${f.message.replace(/\\n/g,'<br>')}</div>
            <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
              <div style="color:#6b6b6b;"><i class="bi bi-clock"></i> ${f.created_at}${ipText}</div>
              <div>
                ${ f.is_read ? 
                   `<button class="btn btn-outline-secondary btn-xs mark-unread" data-id="${f.id}"><i class="bi bi-envelope"></i> Mark unread</button>` :
                   `<button class="btn btn-success btn-xs mark-read" data-id="${f.id}"><i class="bi bi-check2-circle"></i> Mark read</button>` }
              </div>
            </div>
          </div>
        </div>
      `);
      $list.append(card);
    });

    // bind buttons
    $('.mark-read').on('click', function(){
      const id = $(this).data('id');
      $.post('/feedback/read/' + id).done(()=> loadFeedbacks()).fail(()=> alert('Failed'));
    });
    $('.mark-unread').on('click', function(){
      const id = $(this).data('id');
      $.post('/feedback/unread/' + id).done(()=> loadFeedbacks()).fail(()=> alert('Failed'));
    });
  }

  function loadFeedbacks(){
    $('#loading').show();
    $.getJSON('/admin/feedbacks.json')
      .done(function(data){
        $('#loading').hide();
        renderList(data);
      })
      .fail(function(xhr){
        $('#loading').text('Failed to load feedbacks (see server logs).');
      });
  }

  $(function(){
    loadFeedbacks();
    $('#refresh').on('click', loadFeedbacks);
    $('#search').on('input', function(){
      const q = $(this).val().toLowerCase().trim();
      $('.feedback-card').each(function(){
        const name = $(this).data('name') || '';
        const email = $(this).data('email') || '';
        const match = q === '' || name.includes(q) || email.includes(q);
        $(this).toggle(match);
      });
    });

    // footer reveal
    function updateFooter(){
      const scrollBottom = window.innerHeight + window.scrollY;
      const pageHeight = document.documentElement.scrollHeight;
      const footer = document.querySelector('footer');
      if(pageHeight > window.innerHeight + 50 && (pageHeight - scrollBottom) <= 80) footer.classList.add('visible');
      else footer.classList.remove('visible');
    }
    window.addEventListener('scroll', updateFooter, {passive:true});
    window.addEventListener('resize', updateFooter);
    window.addEventListener('load', updateFooter);
  });
</script>

</body>
</html>
